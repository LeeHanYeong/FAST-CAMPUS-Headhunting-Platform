{% extends 'base.jinja2' %}

{% block content_header %}
<header class="content-header">
	<div class="title">
		<span>지원자 이력서 수정</span>
	</div>
	<button onclick="update()" class="btn btn-primary float-right pl-5 pr-5">수정 완료</button>
</header>
{% endblock %}

{% block content %}
<div v-if="applicantDetail" class="resume">
	<section class="card resume-section">
		<div class="card-header">기본정보</div>
		<div class="card-body">
			<form action="">
				<div class="form-group row">
					<label for="id-is-looking" class="col-sm-2 col-form-label">구직 여부</label>
					<div class="col-sm-10">
						<div class="btn-group" role="group">
						  <button v-on:click="applicantDetail.is_looking = true" type="button" class="btn" v-bind:class="{'btn-primary': applicantDetail.is_looking, 'btn-dark': !applicantDetail.is_looking}">구직 중</button>
						  <button v-on:click="applicantDetail.is_looking = false" type="button" class="btn" v-bind:class="{'btn-primary': !applicantDetail.is_looking, 'btn-dark': applicantDetail.is_looking}">재직 중</button>
						</div>
					</div>
				</div>
				<div class="form-group row">
					<label for="id-is-looking" class="col-sm-2 col-form-label">이력서 공개 여부</label>
					<div class="col-sm-10">
						<div class="btn-group" role="group">
						  <button v-on:click="applicantDetail.is_published = true" type="button" class="btn" v-bind:class="{'btn-primary': applicantDetail.is_published, 'btn-dark': !applicantDetail.is_published}">공개</button>
						  <button v-on:click="applicantDetail.is_published = false" type="button" class="btn" v-bind:class="{'btn-primary': !applicantDetail.is_published, 'btn-dark': applicantDetail.is_published}">비공개</button>
						</div>
					</div>
				</div>
				<div class="form-group row">
					<label for="id-img-profile" class="col-sm-2 col-form-label">프로필 이미지</label>
					<div class="col-sm-10 col-md-4">
						<div class="row mb-2">
							<div class="col-sm-5 col-md-8 col-lg-6">
								<img v-bind:src="applicantDetail.img_profile || '{{ static('images/blank_user.png') }}'">
							</div>
						</div>
						<form id="id-form-img-profile" enctype="multipart/form-data">
							<input type="file" id="id-img-profile" class="form-control-file">
						</form>
					</div>
				</div>
				<div class="form-group row">
					<label for="id-lastname" class="col-sm-2 col-form-label">이름</label>
					<div class="col-4 col-sm-3 col-md-2 col-lg-1 mr-0">
						<input v-model="applicantDetail.last_name" id="id-lastname" type="text" class="form-control" placeholder="성" autocomplete="off">
					</div>
					<div class="col-8 col-sm-7 col-md-2 col-lg-1 pl-0">
						<input v-model="applicantDetail.first_name" id="id-firstname" type="text" class="form-control" placeholder="이름" autocomplete="off">
					</div>
				</div>
				<div class="form-group row">
					<label for="id-email" class="col-sm-2 col-form-label">이메일</label>
					<div class="col-sm-10 col-md-4">
						<input v-model="applicantDetail.email" type="email" id="id-email" class="form-control" placeholder="" autocomplete="off">
					</div>
				</div>
				<div class="form-group row">
					<label for="id-birth" class="col-sm-2 col-form-label">생년월일</label>
					<div class="col-sm-10 col-md-4">
						<input v-model="applicantDetail.birth_date" type="text" id="id-birth" class="form-control" placeholder="YYYY-MM-DD (ex: 1990-01-01)" autocomplete="off">
					</div>
				</div>
				<div class="form-group row">
					<label for="id-phone-number" class="col-sm-2 col-form-label">전화번호</label>
					<div class="col-sm-10 col-md-4">
						<input v-model="applicantDetail.phone_number" type="text" id="id-phone-number" class="form-control" placeholder="YYYY-MM-DD (ex: 1990-01-01)" autocomplete="off">
					</div>
				</div>
				<div class="form-group row">
					<label for="id-birth" class="col-sm-2 col-form-label">한줄소개</label>
					<div class="col-sm-10">
						<input v-model="applicantDetail.short_intro" type="text" id="id-birth" class="form-control" placeholder="" autocomplete="off">
					</div>
				</div>
			</form>
		</div>
	</section>
	<section class="card resume-section">
		<div class="card-header">학력사항</div>
		<div>
			<table class="table table-edit">
				<thead>
					<tr>
						<th>학교명</th>
						<th>전공</th>
						<th>기간</th>
						<th>졸업여부</th>
						<th>관리</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(edu, index) in applicantDetail.education_set" :key="edu.pk" class="editable">
						<td>
							<input v-bind:id="'edu-' + index"
							       v-model="edu.school"
							       class="form-control"
							       type="text" v-focus>
							<small class="form-text text-danger"
							       v-for="error in errorMessages('education_set', 'school', index)">
								${ error }</small>
						</td>
						<td>
							<input v-model="edu.major" type="text">
							<small class="form-text text-danger"
							       v-for="error in errorMessages('education_set', 'major', index)">
								${ error }</small>
						</td>
						<td>
							<input v-model="edu.start_date" type="text"> ~
							<input v-model="edu.end_date" type="text">
							<small class="form-text text-danger"
							       v-for="error in errorMessages('education_set', 'start_date', index)">
								${ error }</small>
							<small class="form-text text-danger"
							       v-for="error in errorMessages('education_set', 'end_date', index)">
								${ error }</small>
						<td>
							<select v-model="edu.type">
								<option value="grad">졸업</option>
								<option value="grad_ex">졸업 예정</option>
								<option value="attend">재학</option>
								<option value="dropout">중퇴</option>
							</select>
							<small class="form-text text-danger"
							       v-for="error in errorMessages('education_set', 'type', index)">
								${ error }</small>
						</td>
						<td>
							<button v-on:click="deleteApplicantItem('edu', index)" class="btn btn-sm btn-danger">삭제</button>
						</td>
					</tr>
					<tr>
						<td colspan="5">
							<button v-on:click="addApplicantItem('edu')" class="btn btn-primary">추가</button>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

	<section class="card resume-section">
		<div class="card-header">경력사항</div>
		<div>
			<table class="table table-edit">
				<thead>
					<tr>
						<th>근무처</th>
						<th>담당업무</th>
						<th>기간</th>
						<th>최종직위</th>
						<th>관리</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(career, index) in applicantDetail.career_set" :key="career.pk" class="editable">
						<td>
							<input v-bind:id="'career-' + index"
							       v-model="career.organization"
							       class="form-control"
							       type="text" v-focus>
							<small class="form-text text-danger"
							       v-for="error in errorMessages('career_set', 'organization', index)">
								${ error }</small>
						</td>
						<td>
							<input v-model="career.responsibility" type="text">
							<small class="form-text text-danger"
							       v-for="error in errorMessages('career_set', 'responsibility', index)">
								${ error }</small>
						</td>
						<td>
							<input v-model="career.start_date" type="text"> ~
							<input v-model="career.end_date" type="text">
							<small class="form-text text-danger"
							       v-for="error in errorMessages('career_set', 'start_date', index)">
								${ error }</small>
							<small class="form-text text-danger"
							       v-for="error in errorMessages('career_set', 'end_date', index)">
								${ error }</small>
						</td>
						<td>
							<input v-model="career.position" type="text">
							<small class="form-text text-danger"
							       v-for="error in errorMessages('career_set', 'position', index)">
								${ error }</small>
						</td>
						<td>
							<button v-on:click="deleteApplicantItem('career', index)" class="btn btn-sm btn-danger">삭제</button>
						</td>
					</tr>
					<tr>
						<td colspan="5">
							<button v-on:click="addApplicantItem('career')" class="btn btn-primary">추가</button>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

	<section class="card resume-section">
		<div class="card-header">자격사항</div>
		<div>
			<table class="table table-edit">
				<thead>
					<tr>
						<th>자격증명</th>
						<th>발행처</th>
						<th>취득일</th>
						<th>관리</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(license, index) in applicantDetail.license_set" :key="license.pk" class="editable">
						<td>
							<input v-bind:id="'license-' + index"
							       v-model="license.title"
							       class="form-control"
							       type="text" v-focus>
							<small class="form-text text-danger"
							       v-for="error in errorMessages('license_set', 'title', index)">
								${ error }</small>
						</td>
						<td>
							<input v-model="license.organization" type="text">
							<small class="form-text text-danger"
							       v-for="error in errorMessages('license_set', 'organization', index)">
								${ error }</small>
						</td>
						<td>
							<input v-model="license.get_date" type="text">
							<small class="form-text text-danger"
							       v-for="error in errorMessages('license_set', 'get_date', index)">
								${ error }</small>
						</td>
						<td>
							<button v-on:click="deleteApplicantItem('license', index)" class="btn btn-sm btn-danger">삭제</button>
						</td>
					</tr>
					<tr>
						<td colspan="5">
							<button v-on:click="addApplicantItem('license')" class="btn btn-primary">추가</button>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

	<section class="card resume-section">
		<div class="card-header">자기소개서</div>
		<div class="card-body">
			<form action="">
				<div class="form-group row">
					<div class="col">
						<textarea id="id-intro" v-model="applicantDetail.introduce"></textarea>
					</div>
				</div>
			</form>
		</div>
	</section>
</div>
{% endblock %}

{% block mixin %}
<script>
var mixin = {
  data: {
    errors: {}
  },
	methods: {
	  // ApplicantUpdate
    getSkillLinkList: function () {
      const vm = this;
      $.ajax({
        method: 'GET',
        url: "{{ url('api:members:skill-list') }}"
      }).done(function (response) {
        vm.skillList = response;
      }).fail(function (response) {
        console.log(response);
      });

      $.ajax({
        method: 'GET',
        url: "{{ url('api:members:link-list') }}"
      }).done(function (response) {
        vm.linkList = response;
      }).fail(function (response) {
        console.log(response);
      });
    },
    getApplicantProfile: function () {
      const vm = this;
      console.log('getApplicantProfile');
      $.ajax({
        method: 'GET',
        url: "{{ url('api:members:profile') }}"
      }).done(function (response) {
        vm.applicantDetail = response;
      }).fail(function (response) {
        console.log('fail');
        console.log(response);
      });
    },
    deleteApplicantItem: function (type, index) {
      const vm = this;
      switch (type) {
	      case 'edu':
		      Vue.delete(this.applicantDetail.education_set, index);
		      break;
	      case 'career':
	        Vue.delete(this.applicantDetail.career_set, index);
		      break;
	      case 'license':
	        Vue.delete(this.applicantDetail.license_set, index);
		      break;
      }
    },
		addApplicantItem: function (type) {
      switch (type) {
	      case 'edu':
	        this.applicantDetail.education_set.push({
		        school: '',
		        major: '',
		        start_date: '',
		        end_date: '',
		        type: 'grad'
	        });
	        break;
	      case 'career':
	        this.applicantDetail.career_set.push({
		        organization: '',
		        responsibility: '',
		        start_date: '',
		        end_date: '',
		        position: ''
	        });
	        break;
	      case 'license':
	        this.applicantDetail.license_set.push({
		        title: '',
		        organization: '',
		        get_date: '',
	        });
	        break;
      }
		},
    updateApplicantProfile: function (extraData) {
      const vm = this;
      var obj = $.extend({}, vm.applicantDetail);
      var extraObj = $.extend(obj, extraData);
      console.log(extraObj);
      delete extraObj.img_profile;
      $.ajax({
        method: 'PATCH',
        url: "{{ url('api:members:profile') }}",
        data: JSON.stringify(extraObj),
        contentType: 'application/json',
        processData: false,
        dataType: 'JSON'
      }).done(function (response) {
        var formData = new FormData();
        var file = $('#id-img-profile')[0].files[0];
        if (file) {
          formData.append('img_profile', file);
          console.log(formData);
          $.ajax({
            method: 'PATCH',
            url: "{{ url('api:members:profile') }}",
            data: formData,
            processData: false,
            contentType: false,
          }).done(function (response) {
            vm.errors = {}
            vm.applicantDetail = response;
            $('#id-img-profile').val('');
          });
        } else {
          vm.errors = {}
          vm.applicantDetail = response;
        }
      }).fail(function (response) {
        console.log(response);
        vm.errors = response.responseJSON;
      });
    },
		errorMessages: function (type, name, index) {
      const vm = this;
      if (type in vm.errors) {
				if (!(typeof vm.errors[type][index] === 'undefined')) {
					if (name in vm.errors[type][index]) {
	          return vm.errors[type][index][name];
	        }
				}
      }
		}
	}
};
</script>
{% endblock %}

{% block script %}
<script>
	app.getSkillLinkList();
	app.getApplicantProfile();
	var editor = CKEDITOR.replace('id-intro', {
	  toolbar: 'Default',
		height: 500
	});

	function update () {
	  console.log('update');
	  var editorData = editor.getData();
	  var extraData = {
	    introduce: editorData
	  };
	  app.updateApplicantProfile(extraData);
	}
</script>
{% endblock %}